<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/nostr-tools/lib/nostr.bundle.js"></script>
    <title>MeShell</title>
    <link href="styles.css" rel="stylesheet"></link>
</head>
<body>
    <script>
        //RELAYS
        var pubKey = localStorage.getItem("pubKey");
        var privKey = localStorage.getItem("privKey");
        var npub = localStorage.getItem("npub");
        var nsec = localStorage.getItem("nsec");

        relay1URL = "wss://nostr-pub.wellorder.net";
        relay2URL = "wss://relay.nostr.info"

        const defaultRelay1 = window.NostrTools.relayInit(relay1URL);
        const defaultRelay2 = window.NostrTools.relayInit(relay2URL);
        
        defaultRelay1.connect();
        defaultRelay2.connect();

        defaultRelay1.on('connect', () => {
        console.log(`connected to ${defaultRelay1.url}`)
        })
        defaultRelay1.on('error', () => {
        console.log(`failed to connect to ${defaultRelay1.url}`)
        })

        defaultRelay2.on('connect', () => {
        console.log(`connected to ${defaultRelay2.url}`)
        })
        defaultRelay2.on('error', () => {
        console.log(`failed to connect to ${defaultRelay2.url}`)
        })
    </script>
    <script>
        //SUB TO ME
        let subMe1 = defaultRelay1.sub([
          {
            kinds: [1],
            authors: [pubKey]
          }
        ])
    
        subMe1.on('event', event => {
          console.log('got event:', event)
        })
    
        let subMe2 = defaultRelay2.sub([
          {
            kinds: [1],
            authors: [pubKey]
          }
        ])
    
        subMe2.on('event', event => {
          console.log('got event:', event)
        })
    </script>
    <script>
        //PUBLISH NOTE
        function makeNote (note) {
            let event = {
              kind: 1,
              pubkey: pubKey,
              created_at: Math.floor(Date.now() / 1000),
              tags: [],
              content: note
            };
            event.id = window.NostrTools.getEventHash(event);
            event.sig = window.NostrTools.signEvent(event, privKey);
    
            let pubRelay1 = defaultRelay1.publish(event)
            pubRelay1.on('ok', () => {
              console.log(`${defaultRelay1.url} has accepted our event`)
            })
            pubRelay1.on('seen', () => {
              console.log(`we saw the event on ${defaultRelay1.url}`)
            })
            pubRelay1.on('failed', reason => {
              console.log(`failed to publish to ${defaultRelay1.url}: ${reason}`)
            })
    
            let pubRelay2 = defaultRelay2.publish(event)
            pubRelay1.on('ok', () => {
              console.log(`${defaultRelay2.url} has accepted our event`)
            })
            pubRelay2.on('seen', () => {
              console.log(`we saw the event on ${defaultRelay2.url}`)
            })
            pubRelay2.on('failed', reason => {
              console.log(`failed to publish to ${defaultRelay2.url}: ${reason}`)
            })

            modal.style.display = "none";
            document.getElementById('publish-textarea').value = '';
        }
    </script>
    <script>
        //CHANGE USER METADATA
        function SendMetadata(textPetname, textAbout, urlProfilePicture) {
    
            localStorage.setItem("NickName", textPetname);
            localStorage.setItem("UserAbout", textAbout);
            localStorage.setItem("UserPPicture", urlProfilePicture);
    
            var name = "";
            var about = "";
            var picture = "";
    
            var set_metadata = JSON.parse(localStorage.getItem("my-meta-info")) || {};
    
            if (document.getElementById("petnameInput")) {
            name = document.getElementById("petnameInput").value;
            } else {
            name = "";
            }
    
            if (document.getElementById("aboutTextArea")) {
            about = document.getElementById("aboutTextArea").value;
            } else {
            about = "";
            }
    
            if (document.getElementById("pictureInput")) {
            picture = document.getElementById("pictureInput").value;
            } else {
            picture = "";
            }
    
            set_metadata["name"] = name;
            set_metadata["about"] = about;
            set_metadata["picture"] = picture;
    
            localStorage.setItem("my-meta-info", JSON.stringify(set_metadata));;
    
            var note = JSON.stringify( set_metadata );
    
            let event = {
              kind: 0,
              pubkey: pubKey,
              created_at: Math.floor(Date.now() / 1000),
              tags: [],
              content: note
            };
            event.id = window.NostrTools.getEventHash(event);
            event.sig = window.NostrTools.signEvent(event, privKey);
    
            let pubRelay1 = defaultRelay1.publish(event)
            pubRelay1.on('ok', () => {
              console.log(`${defaultRelay1.url} has accepted our event`)
            })
            pubRelay1.on('seen', () => {
              console.log(`we saw the event on ${defaultRelay1.url}`)
            })
            pubRelay1.on('failed', reason => {
              console.log(`failed to publish to ${defaultRelay1.url}: ${reason}`)
            })
    
            let pubRelay2 = defaultRelay2.publish(event)
            pubRelay1.on('ok', () => {
              console.log(`${defaultRelay2.url} has accepted our event`)
            })
            pubRelay2.on('seen', () => {
              console.log(`we saw the event on ${defaultRelay2.url}`)
            })
            pubRelay2.on('failed', reason => {
              console.log(`failed to publish to ${defaultRelay2.url}: ${reason}`)
            })

            settingsModal.style.display = "none";
            location.reload();
        }
    </script>
    <img id="HomeLogo" 
        src="/assets/MeShell_Logo_200_blank.png" 
        alt="MeShell Logo" 
        title="Michel" 
        width="150px">

    <div class="feed-selector">
        <img id="first-edition-logo"
            src="/assets/firstedition.png"
            title="First Edition">
        <br>
        <img id="global-logo"
            src="/assets/global.png"
            title="Global Chat">
            <br>
        <img id="messages-logo"
            src="/assets/message-logo.png"
            title="Direct Messages">
        <br>
        <button id="publish-button">
            <img class="publish-logo"
            src="/assets/publish.png"
            title="Publish">
        </button>
        <br>
        <button id="settings-button">
            <img id = "settingsLogo"
            src="/assets/settings-logo.png"
            title="Settings">
        </button>
    </div>
    <div id="publish-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <textarea id="publish-textarea"
                    rows="15"
                    autocomplete="off"
                    autocapitalize="on"
                    placeholder="Say something to the world"></textarea>
            <br>
            <div id="padding-button"></div>
            <div id="makeNoteButton">
            <button id="publish-text-button" onclick="makeNote(document.getElementById('publish-textarea').value)">
                Publish
            </button>
            </div>
        </div>
    </div>
    <div id="settings-modal-id" class="settings-modal">
        <div class="settings-modal-content">
            <div class="settingsClose">&times;</div>
            <div class="settingsSection">
                <div id="inputSection">
                    <div id="userNameTextSettings">User Name</div>
                    <input id="petnameInput"
                            placeholder="Your name here">
                
                    <div id="AboutTextsettings">About</div>
                    <textarea id="aboutTextArea"
                        placeholder = "You can write about yourself"></textarea>
                
                    <div id="PictureSettings">Profile Picture</div>
                    <input id = "pictureInput"
                        placeholder = "Paste your link here">
                    <br>
                    <button id="previewChangesButton" onclick="previewChanges()">Preview</button>
                    <br>
                    <button id="saveChangesButton" onclick="SendMetadata(document.getElementById('petnameInput').value, document.getElementById('aboutTextArea').value, document.getElementById('pictureInput').value)">Save</button>
                </div>
                <div id="previewSection">
                    <div id="previewPPictureContainer">
                        <img id="previewPPicture" src="" style="display: none;">
                        <div id="identiconPreview" style="display: none;"></div>
                    </div>
                    <div id="previewNickName"></div>
                    <div id="previewPubkey"></div>
                    <div id="previewBio"></div>
                </div>
            </div>
            <div id="relayContainer">
                <!-- 
                <script>
                    document.getElementById("relay1").innerHTML = relay1URL;
                    document.getElementById("relay2").innerHTML = relay2URL;
                </script>

                <div id = "relaysText">Relays</div>
                <ul id="relaysList">
                    <li id="relay1"></li>
                    <li id="relay2"></li>
                </ul>
                <input type="text" id="relayInput">
                <button id="addRelay">Add Relay</button>
                -->
            </div>
        </div>
        <script>
            //SETTINGS MODAL
            var settingsModal = document.getElementById("settings-modal-id");
            var settingsButton = document.getElementById("settings-button");
            var settingsCloseButton = document.getElementsByClassName("settingsClose")[0];
            var textPetname = document.getElementById("petnameInput").value;
            var textAbout = document.getElementById("aboutTextArea").value;
            var urlProfilePicture = document.getElementById("pictureInput").value;
        
            settingsButton.onclick = function() {
                settingsModal.style.display = "block";
                
                if (!UserPPicture) {
                    document.getElementById('identiconPreview').innerHTML = stringSvgDiv;
                    document.getElementById('identiconPreview').style.display = "block";
                } else {
                    document.getElementById('previewPPicture').src = UserPPicture;
                    document.getElementById('previewPPicture').style.display = "block";
                }

                document.getElementById("petnameInput").value = NickName;
                document.getElementById("aboutTextArea").value = UserAbout;
                document.getElementById("previewPPicture").value = UserPPicture;
                document.getElementById('previewNickName').innerHTML = NickName;
                document.getElementById('previewBio').innerHTML = UserAbout;
                document.getElementById('previewPubkey').innerHTML = npub;
            }
        
            settingsCloseButton.onlick = function() {
                location.reload();
                settingsModal.style.display = "none";
            }
        
            window.onclick = function(event) {
                if (event.target == settingsModal) {
                    settingsModal.style.display = "none";
                }
            }
        
            function previewChanges () {
                var textNickN = document.getElementById("petnameInput").value;
                var textAboutpreview = document.getElementById("aboutTextArea").value;
                var urlProfilePictureNew = document.getElementById("pictureInput").value;

                document.getElementById('previewPPicture').src = urlProfilePictureNew;
                document.getElementById('identiconPreview').style.display = "block";
                document.getElementById('previewNickName').innerHTML = textNickN;
                document.getElementById('previewBio').innerHTML = textAboutpreview;
                document.getElementById('previewPubkey').innerHTML = npub;
            };
        </script>
    </div>
    <script>
        //PUBLISH MODAL
        var modal = document.getElementById("publish-modal");
        var btn = document.getElementById("publish-button");
        var span = document.getElementsByClassName("close")[0];
        var text = document.getElementById('publish-textarea');

        btn.onclick = function() {
        modal.style.display = "block";
        }

        span.onclick = function() {
        modal.style.display = "none";
        document.getElementById('publish-textarea').value = '';
        }

        window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
            document.getElementById('publish-textarea').value = '';
        }
        }
    </script>
    </div>
    <div class="articles">
        <div id="userInfo">
            <div id="homeProfilePicContainer">
                <img id="homeProfilePic" style="display: none;">
                <div id="identicon" style="display: none;"></div>
            </div>
            <div id="homeUserName"></div>
            <div id="publickeyhome"></div>
            <div id="userBio"></div>
            <div id="following"></div>
            <div id="followers"></div>
            <script type="module">
                import { identiconSvg } from 'https://unpkg.com/minidenticons@2.0.0/minidenticons.min.js'
            </script>
            <script>
                var stringSvgDiv = "<identicon-svg username='" + pubKey + "'></identicon-svg>";
                var UserPPicture = localStorage.getItem("UserPPicture");

                if (!UserPPicture) {
                    document.getElementById('identicon').innerHTML = stringSvgDiv;
                    document.getElementById('identicon').style.display = "block";
                } else {
                    document.getElementById('homeProfilePic').src = UserPPicture;
                    document.getElementById('homeProfilePic').style.display = "block";
                }

                var NickName = localStorage.getItem('NickName');
                if (!NickName) {
                    document.getElementById("homeUserName").style.display = "none";
                } else {
                    document.getElementById("homeUserName").innerHTML = NickName;
                }


                var UserAbout = localStorage.getItem('UserAbout');
                if (!UserAbout) {
                    document.getElementById("userBio").style.display = "none";
                } else {
                    document.getElementById("userBio").innerHTML = UserAbout;
                }

                document.getElementById('publickeyhome').innerHTML = npub;
                
            </script>
            <br>
            <br>
        </div>
        <!-- USER EVENTS CONTAINER -->
        <div id="card-container"></div>
        <div id="loader">
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
        </div>
        <div class="card-actions">
            <span>Showing
                <span id="card-count"></span> of
                <span id="card-total"></span> Notes
            </span>
        </div>
        <!-- MESSAGES LIST-->
        <div id="messagesList" style="display: none;">
            <p>Messages List</p>
        </div>

        <script>
            //MESSAGE SECTION
            document.getElementById("messages-logo").addEventListener("click", function() {
                document.getElementById("card-container").innerHTML = document.getElementById("messagesList").innerHTML;
                document.getElementById('loader').style.display = "block";
                document.querySelector('.skeleton-card').style.display = "none";
                document.querySelector('.card-actions').style.display = "none";
            });
        </script>

        <script>
            //USER EVENT CONTAINER
            const cardContainer = document.getElementById("card-container");
            const cardCountElem = document.getElementById("card-count");
            const cardTotalElem = document.getElementById("card-total");
            const loader = document.getElementById("loader");

            const cardLimit = 99;
            const cardIncrease = 12;
            const pageCount = Math.ceil(cardLimit / cardIncrease);
            let currentPage = 1;

            cardTotalElem.innerHTML = cardLimit;

            var throttleTimer;
            const throttle = (callback, time) => {
            if (throttleTimer) return;

            throttleTimer = true;

            setTimeout(() => {
                callback();
                throttleTimer = false;
            }, time);
            };

            const createCard = (index) => {
            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = index;
            card.style.backgroundColor = "white";
            cardContainer.appendChild(card);
            };

            const addCards = (pageIndex) => {
            currentPage = pageIndex;

            const startRange = (pageIndex - 1) * cardIncrease;
            const endRange =
                currentPage == pageCount ? cardLimit : pageIndex * cardIncrease;

            cardCountElem.innerHTML = endRange;

            for (let i = startRange + 1; i <= endRange; i++) {
                createCard(i);
            }
            };

            const handleInfiniteScroll = () => {
            throttle(() => {
                const endOfPage =
                window.innerHeight + window.pageYOffset >= document.body.offsetHeight;

                if (endOfPage) {
                addCards(currentPage + 1);
                }

                if (currentPage === pageCount) {
                removeInfiniteScroll();
                }
            }, 1000);
            };

            const removeInfiniteScroll = () => {
            loader.remove();
            window.removeEventListener("scroll", handleInfiniteScroll);
            };

            window.onload = function () {
            addCards(currentPage);
            };

            window.addEventListener("scroll", handleInfiniteScroll);
        </script>
    </div>
    <div class="right-section">
        <div id="input-pubkey">
            <input type="text" autocomplete="off" placeholder="enter public key to search">
        </div>
    </div>
</body>
</html>